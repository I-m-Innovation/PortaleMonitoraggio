{% extends 'base_layout.html' %}
{% load static %}

  <!-- Carica il modulo con i filtri personalizzati -->

{% block title %}Diario Letture - {{ impianto.nome_impianto }}{% endblock %}

{% block extra_css %}
    <!-- Inclusione del CSS personalizzato per il Diario delle Letture -->
    <link rel="stylesheet" href="{% static 'css/reg_segnanti.css' %}">
    <!-- Inclusione del CSS per Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
{% endblock extra_css %}

{% block content %}
{% csrf_token %}

<div class="container" style="margin-top: 30px;">
    {% if contatore_selezionato %}
        <ul class="list-group">
            <li class="list-group-item">Pod: {{ contatore_selezionato.pod }}</li>
            <li class="list-group-item">Nome: {{ contatore_selezionato.nome }}</li>
            <li class="list-group-item">k: {{ contatore_selezionato.k }}</li>
            <li class="list-group-item">Matricola: {{ contatore_selezionato.matricola }}</li>
            <li class="list-group-item">Modello: {{ contatore_selezionato.modello }}</li>
            <li class="list-group-item">Data installazione: {{ contatore_selezionato.data_installazione }}</li>
        </ul>
    {% else %}
        <div class="alert alert-danger">
            <h5>Nessun contatore trovato!</h5>
            <p>Non Ã¨ possibile continuare senza un contatore configurato per questo impianto.</p>
            <a href="{% url 'elenco-contatori' nickname=impianto.nickname %}" class="btn btn-primary">
                Gestisci Contatori
            </a>
        </div>
    {% endif %}
</div>

{% if contatore_selezionato %}
<div class="tabelle-container contatore-{{ contatore_selezionato.tipologia|lower }}">
    <div class="header-bar">
        <div class="header-title">
            {{ impianto.nome_impianto }} - {{ contatore_selezionato.nome }}
        </div>
        <div> <button type="button" class="btn btn-light" onclick="window.location.href='{% url 'panoramica-contatore' nickname=impianto.nickname %}'">Torna a diario letture </button> </div>
        <div class="dropdown-container">
            <select id="year-select" class="custom-select">
                <option value="2020" {% if anno_corrente == '2020' %}selected{% endif %}>2020</option>
                <option value="2021" {% if anno_corrente == '2021' %}selected{% endif %}>2021</option>
                <option value="2022" {% if anno_corrente == '2022' %}selected{% endif %}>2022</option>
                <option value="2023" {% if anno_corrente == '2023' %}selected{% endif %}>2023</option>
                <option value="2024" {% if anno_corrente == '2024' %}selected{% endif %}>2024</option>
                <option value="2025" {% if anno_corrente == '2025' %}selected{% endif %}>2025</option>
                <option value="2026" {% if anno_corrente == '2026' %}selected{% endif %}>2026</option>
                <option value="2027" {% if anno_corrente == '2027' %}selected{% endif %}>2027</option>
                <option value="2028" {% if anno_corrente == '2028' %}selected{% endif %}>2028</option>
                <option value="2029" {% if anno_corrente == '2029' %}selected{% endif %}>2029</option> 
            </select>
        </div>
    </div>
    <div class="table-container table-responsive">
        <div id="datitrifascia"  class="table-content" >
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Data e ora presa</th>
                        <th>A1-</th>
                        <th>A2-</th>
                        <th>A3-</th>
                        <th>Totale -</th>
                        <th>Totale calcolato -</th>
                        <th>A1+</th>
                        <th>A2+</th>
                        <th>A3+</th>
                        <th>Totale +</th>
                        
                    </tr>
                </thead>
                <tbody>
                    <!-- Gennaio -->
                    <tr data-mese="1">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="1" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Febbraio -->
                    <tr data-mese="2">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="2" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Marzo -->
                    <tr data-mese="3">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="3" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Aprile -->
                    <tr data-mese="4">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="4" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Maggio -->
                    <tr data-mese="5">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="5" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Giugno -->
                    <tr data-mese="6">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="6" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Luglio -->
                    <tr data-mese="7">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="7" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Agosto -->
                    <tr data-mese="8">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="8" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Settembre -->
                    <tr data-mese="9">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="9" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Ottobre -->
                    <tr data-mese="10">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="10" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Novembre -->
                    <tr data-mese="11">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="11" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Dicembre -->
                    <tr data-mese="12">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="12" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                    
                    <!-- Gennaio dell'anno successivo (13a riga) -->
                    <tr data-mese="13" data-anno="{{ anno_corrente|add:1 }}">
                        <td data-field="data_ora_lettura" contenteditable="true" class="editable-cell" data-mese="13" placeholder="gg/mm/aaaa hh:mm">
                            
                        </td>   
                        <td data-field="a1_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_neg" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_neg" class="calculated-field"></td>
                        <td data-field="totale_calcolato_neg" class="calculated-field"></td>
                        <td data-field="a1_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a2_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="a3_pos" contenteditable="true" class="editable-cell"></td>
                        <td data-field="totale_pos" class="calculated-field"></td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
    <div class="save-button-container">
        <button id="save-button-trifasica" class="btn btn-primary" 
                data-contatore-id="{{ contatore_selezionato.id }}" 
                data-impianto-id="{{ impianto.id }}"
                data-save-url="{% url 'salva-letture-trifasica' contatore_id=contatore_selezionato.id %}">
            <i class="bi bi-save"></i> Salva
        </button>
        <!-- Debug: mostra gli ID per verificare -->
        <small class="text-muted">Debug: Contatore ID = {{ contatore_selezionato.id }}, Impianto ID = {{ impianto.id }}</small>
    </div>

</div>
{% endif %}
{% endblock content %}


{% block extra_js %}
    {% if contatore_selezionato %}
        <script src="{% static 'js/reg_segnantitrifascia.js' %}"></script>
    {% else %}
        <script>
            console.log('Nessun contatore selezionato - JavaScript non caricato');
        </script>
    {% endif %}
{% endblock extra_js %}
