{% load static %}


{% for nickname, impianto in plants_overview.items %}
	{% if impianto.tipo == 'Idroelettrico' %}
  <a target="_blank" style="text-decoration: none; padding: 0 5px" href="{% url 'monitoraggio-impianto' nickname %}">
    <div class="card1" >
	    <div class="go-corner" style="background-color: #88a7ce;" ><div class="go-arrow">→</div></div>
      <table style="color: #283c50; width: 100%;">
        <colgroup>
					<col span="1" style="width: 8%;">
					<col span="1" style="width: 18%;">
					<col span="1" style="width: 8%;">
					
					<col span="1" style="width: 12%;">
			    <col span="1" style="width: 22%;">
			    <col span="1" style="width: 16%;">
			    <col span="1" style="width: 16%;">
        </colgroup>
	      <tbody>
          <tr style="border-collapse: collapse; font-size: 15px">
            <td style="border: none">
	            <div>
		            <img src="{% static 'images/weather_icons/'|add:impianto.curr_icona  %}" alt="weather" style="height: 50px">
	            </div>
	            <div style="margin-top: -10px">
		            <small style="font-size: 12px; color: #939393; margin-left: 10px">{{ impianto.curr_temp }}°C</small>
	            </div>
            </td>
            <td style="padding-left: 10px">
	            <b>{{ impianto.Name }}</b>
            </td>
	          <td style="text-align: center;">
	            <div class="led-box" style="margin:0; padding: 10% 0 0 30%"><div class="{{ impianto.state }}" style="width: 20px; height: 20px"></div></div>
            </td>
            <td style="text-align: center; border: none; "><div id="minichart_{{ nickname }}" class="minichartIdro"></div></td>
	          {% load humanize %}{% load i18n %}{% load l10n %}
	          {% language 'de' %}
            <td style="text-align: end"><b>{% if impianto.last_power %}{{ impianto.last_power| floatformat:"0g" }} kW {% else %} - {% endif %} </b><span style="color: #9f9f9f; font-size: 12px"> / {{ impianto.potenza_installata|floatformat:"2g" }} kW</span></td>
            <td style="text-align: center;"><b>{% if impianto.Energy %} {{ impianto.Energy| floatformat:"0g" }} kWh {% else %} - {% endif %} </b></td>
	          {% endlanguage %}
            <td style="text-align: center;"><b>{% if impianto.last_eta %} {% widthratio impianto.last_eta 1 100 %} % {% else %} - {% endif %} </b></td>
          </tr>
        </tbody>
	      <tfoot >
	      <tr style="width: 100%">
		      <td id="lastT_{{ nickname }}" class="aggiornamento-IdroTable-card" colspan="7">
			      aggiornamento: 
		      </td>
	      </tr>
        </tfoot>
	      <script>
          $(document).ready(function(){
		          var endpoint = '{% url 'api-monitoraggio-impianto' nickname %}';
		          let idMiniChart = 'minichart_'.concat('{{ nickname }}');
		          let idLastT = 'lastT_'.concat('{{ nickname }}');
		          let text = 'aggiornamento: '.concat('');
		          
		          var MiniChart = echarts.init(document.getElementById(idMiniChart));
		          window.addEventListener('resize', function() {MiniChart.resize();});
		          
		          $.get(endpoint).done(function (data) {
				          let potenza = data.potenza;
				          let timestamps = data.timestamps;
				          let last_index = data.last_index;
				          let last_t = timestamps[last_index];
				          last_t = text.concat(last_t);
				          document.getElementById(idLastT).innerHTML = last_t;
				          
				          MiniChart.setOption({
						          color: ['rgb(248,123,104)'],
						          xAxis: [{ data: timestamps, show: false }], 
						          yAxis: {type: 'value', min: 0, max: {{ impianto.potenza_installata|stringformat:".2f" }}, offset:80, show: false},
						          grid:[{top:0,bottom:0,right:0,left:0}],
						          series: [{
								          data: potenza, type: 'line',areaStyle: {},showSymbol: false,lineStyle:{width: 1,}
						          }]
				          })
		          })
          })
	      </script>
      </table>
    </div>
  </a>
	{% endif %}
{% endfor %}

