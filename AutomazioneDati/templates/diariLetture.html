{% extends 'base_layout.html' %}
{% load static %}
{% load app_tags %}
  <!-- Carica il modulo con i filtri personalizzati -->

{% block title %}Diario Letture - {{ impianto.nome_impianto }}{% endblock %}

{% block extra_css %}
    <!-- Inclusione del CSS personalizzato per il Diario delle Letture -->
    <link rel="stylesheet" href="{% static 'css/diariLetture.css' %}">
    <!-- Inclusione del CSS per Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
{% endblock extra_css %}

{% block content %}
<!-- Blocco dei dettagli del contatore posizionato al di fuori del container principale -->

{% csrf_token %}  <!-- Aggiungi il token CSRF per le richieste POST -->

<div class="container" style="margin-top: 30px;">
  <!-- Aggiungi il token CSRF per le richieste POST -->
        <ul class="list-group">
            <li class="list-group-item">POD: {{ contatore.pod }}</li>
            <li class="list-group-item">Tipologia: {{ contatore.tipologia }}</li>
            <li class="list-group-item">K: {{ contatore.k }}</li>
            <li class="list-group-item">Marca: {{ contatore.marca }}</li>
            <li class="list-group-item">Modello: {{ contatore.modello }}</li>
            <li class="list-group-item">Data installazione: {{ contatore.data_installazione|date:"d/m/Y" }}</li>
        </ul>
    </div>
    
    <!-- Tabelle container con classe dinamica basata sulla tipologia del contatore -->
    <div class="tabelle-container contatore-{{ contatore.tipologia|lower }}">
        <div class="header-bar">
            <div class="header-title">
                {{ impianto.nome_impianto }} - {{ contatore.nome }}
            </div>
            <div> <button type="button" class="btn btn-light" onclick="window.location.href='{% url 'panoramica-contatore' nickname=impianto.nickname %}'">Trona a registro segnanti </button> </div>
            <div class="dropdown-container">
                <select id="year-select" class="custom-select">
                    <option value="2021" {% if anno_corrente == '2021' %}selected{% endif %}>2021</option>
                    <option value="2022" {% if anno_corrente == '2022' %}selected{% endif %}>2022</option>
                    <option value="2023" {% if anno_corrente == '2023' %}selected{% endif %}>2023</option>
                    <option value="2024" {% if anno_corrente == '2024' %}selected{% endif %}>2024</option>
                    <option value="2025" {% if anno_corrente == '2025' %}selected{% endif %}>2025</option>
                </select>
            </div>
        </div>

        <!-- Wrapper per la navigazione tra le tabelle del contatore -->
        <div class="table-switcher-wrapper">
            
            
            <div class="table-container table-responsive">
                <!-- Seconda tabella - Libro Energie (mostrata solo per contatori Gesis) -->
                <div id="libro_energie" class="table-content" data-contatore-id="{{ contatore.id }}" 
                     style="display: {% if contatore.marca == 'Gesis' %}block{% else %}none{% endif %};">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th>Ora presa</th>
                                <th>A1-</th>
                                <th>A2-</th>
                                <th>A3-</th>
                                <th>Totale -</th>
                                <th>A1+</th>
                                <th>A2+</th>
                                <th>A3+</th>
                                <th>Totale +</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                            {% for dati in libro_energie_dati %}
                            <tr data-mese="{{ dati.mese }}">
                                <td class="mese-con-anno"></td>
                                <td data-field="ora_lettura" contenteditable="true" class="editable-cell"
                                    {% if dati.ora_lettura %}data-ora="{{ dati.ora_lettura|time:'H:i' }}"{% endif %}>
                                    {% if dati.ora_lettura %}{{ dati.ora_lettura|time:"H:i" }}{% endif %}
                                </td> 
                                <td data-field="a1_neg" contenteditable="true" class="editable-cell">
                                    {% if dati.a1_neg is not None %}{{ dati.a1_neg|format_decimal }}{% endif %}
                                </td>
                                <td data-field="a2_neg" contenteditable="true" class="editable-cell">
                                    {% if dati.a2_neg is not None %}{{ dati.a2_neg|format_decimal }}{% endif %}
                                </td>
                                <td data-field="a3_neg" contenteditable="true" class="editable-cell">
                                    {% if dati.a3_neg is not None %}{{ dati.a3_neg|format_decimal }}{% endif %}
                                </td>
                                <td data-field="totale_neg" class="calculated-field">
                                    {% if dati.totale_neg is not None %}{{ dati.totale_neg|format_decimal }}{% endif %}
                                </td>
                                <td data-field="a1_pos" contenteditable="true" class="editable-cell">
                                    {% if dati.a1_pos is not None %}{{ dati.a1_pos|format_decimal }}{% endif %}
                                </td>
                                <td data-field="a2_pos" contenteditable="true" class="editable-cell">
                                    {% if dati.a2_pos is not None %}{{ dati.a2_pos|format_decimal }}{% endif %}
                                </td>
                                <td data-field="a3_pos" contenteditable="true" class="editable-cell">
                                    {% if dati.a3_pos is not None %}{{ dati.a3_pos|format_decimal }}{% endif %}
                                </td>
                                <td data-field="totale_pos" class="calculated-field">
                                    {% if dati.totale_pos is not None %}{{ dati.totale_pos|format_decimal }}{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Tabella Libro Kaifa -->
                <div id="libro_kaifa" class="table-content" data-contatore-id="{{ contatore.id }}"
                     style="display: {% if contatore.marca == 'Kaifa' %}block{% else %}none{% endif %};">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th>Ora presa</th>
                                <th>1.8.0.n</th>
                                <th>Totale 1.8.0.n</th>
                                <th>2.8.0.n</th>
                                <th>Totale 2.8.0.n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in num_rows %}
                            {% with lettura_kaifa=libro_kaifa_dati|get_item:i %}
                            <tr data-mese="{{ i|add:1 }}">
                                <td class="mese-con-anno"></td>
                                <td data-field="ora_lettura" contenteditable="true" class="editable-cell"
                                    {% if lettura_kaifa and lettura_kaifa.ora_lettura %}data-ora="{{ lettura_kaifa.ora_lettura|time:'H:i' }}"{% endif %}>
                                    {% if lettura_kaifa and lettura_kaifa.ora_lettura %}{{ lettura_kaifa.ora_lettura|time:"H:i" }}{% endif %}
                                </td>
                                <td data-field="kaifa_180n" contenteditable="true" class="editable-cell">
                                    {% if lettura_kaifa and lettura_kaifa.kaifa_180n is not None %}
                                        {{ lettura_kaifa.kaifa_180n|format_decimal }}
                                    {% endif %}
                                </td>
                                <td data-field="totale_180n" class="calculated-field">
                                    {% if lettura_kaifa and lettura_kaifa.totale_180n is not None %}
                                        {{ lettura_kaifa.totale_180n|format_decimal }}
                                    {% endif %}
                                </td>
                                <td data-field="kaifa_280n" contenteditable="true" class="editable-cell">
                                    {% if lettura_kaifa and lettura_kaifa.kaifa_280n is not None %}
                                        {{ lettura_kaifa.kaifa_280n|format_decimal }}
                                    {% endif %}
                                </td>
                                <td data-field="totale_280n" class="calculated-field">
                                    {% if lettura_kaifa and lettura_kaifa.totale_280n is not None %}
                                        {{ lettura_kaifa.totale_280n|format_decimal }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            
        </div>
        
        <div class="save-button-container">
            <button id="save-button-diarioletture" class="btn btn-primary" 
                    data-contatore-id="{{ contatore.id }}" 
                    data-impianto-id="{{ impianto.id }}">
                <i class="bi bi-save"></i> Salva
            </button>
        </div>
    </div>



   
</div>

{% endblock content %}

{% block extra_js %}
    <script src="{% static 'js/diariLetture.js' %}"></script>

{% endblock extra_js %}
