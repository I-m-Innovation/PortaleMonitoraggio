{% load static %}
<style>
	/* Stili per la tabella del report mensile */
	#table2_{{ anno }} {
	  border-collapse: collapse;
	  width: 100%;
	  border-radius: 8px;
	  overflow: hidden;
	  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
	  background: rgba(255, 255, 255, 0.9);
	  backdrop-filter: blur(5px);
	  -webkit-backdrop-filter: blur(5px);
	  margin-bottom: 20px;
	}
	
	#table2_{{ anno }} thead {
	  background-color: #518ffa;
	  color: white;
	}
	
	#table2_{{ anno }} th {
	  padding: 12px 8px;
	  text-align: center;
	  font-weight: 500;
	  border: 1px solid #e0e0e0;
	}
	
	#table2_{{ anno }} tbody tr:nth-child(even) {
	  background-color: #f5f8ff;
	}
	
	#table2_{{ anno }} tbody tr:hover {
	  background-color: #e5f1ff;
	  transition: background-color 0.2s ease;
	}
	
	#table2_{{ anno }} td {
	  padding: 8px;
	  border: 1px solid #e0e0e0;
	  text-align: center;
	}
	
	#table2_{{ anno }} td:first-child {
	  font-weight: 500;
	  background-color: #f1f1f1;
	}
	
	#table2_{{ anno }} tfoot {
	  background-color: #f1f1f1;
	  font-weight: bold;
	}
	
	#table2_{{ anno }} tfoot td {
	  padding: 8px;
	  border: 1px solid #e0e0e0;
	}
	
	#table2_{{ anno }} i.fa {
	  margin-right: 4px;
	}
	
	/* Stile per la riga del totale annuale */
	#table2_{{ anno }} tfoot tr:first-child {
	  font-weight: bold;
	  background-color: #d3e5ff;
	}
	
	/* Note a pi√® di pagina */
	#table2_{{ anno }} tfoot tr:last-child td {
	  font-size: 0.85em;
	  color: #555;
	  font-style: italic;
	}
  </style>
  
<table id="table2_{{ anno }}" class="display compact" style="width:100%;">
  <thead>
    <tr data-dt-order="disable">
      
      <th rowspan="2" data-dt-order="disable"> Mese </th>
      <th colspan="3" data-dt-order="disable" style="text-align: center" > Misure campo (kWh) </th>
      <th colspan="3" data-dt-order="disable" style="text-align: center"> Misure e-Dist (kWh) </th>
      <th colspan="2" data-dt-order="disable" style="text-align: center"> Misure GSE (kWh) </th>
      <th rowspan="2" colspan="2" data-dt-order="disable" style="text-align: center; width: 25%"> Controllo misure</th>
	    
    </tr>
    <tr data-dt-order="disable">
      <th>prodotta</th>
      <th>immessa</th>
      <th>prelevata</th>
      <th>prodotta</th>
      <th>immessa</th>
      <th>prelevata</th>
      <th>prodotta</th>
      <th>immessa</th>
    </tr>
  </thead>
  <tbody>
    <!-- I dati verranno popolati dinamicamente tramite JavaScript -->
    {% for mese in "123456789101112"|make_list %}
    <tr>
     
      <td class="mese" data-mese="{{ mese }}"></td>
      <td class="prod-campo" data-mese="{{ mese }}"></td>
      <td class="imm-campo" data-mese="{{ mese }}"></td>
      <td class="prel-campo" data-mese="{{ mese }}"></td>
      <td class="prod-ed" data-mese="{{ mese }}"></td>
      <td class="imm-ed" data-mese="{{ mese }}"></td>
      <td class="prel-ed" data-mese="{{ mese }}"></td>
      <td class="prod-gse" data-mese="{{ mese }}"></td>
      <td class="imm-gse" data-mese="{{ mese }}"></td>
      <td class="controllo" data-mese="{{ mese }}"></td>
      <td></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      
      <td><b>Anno</b></td>
      <td class="totale-prod-campo"></td>
      <td class="totale-imm-campo"></td>
      <td class="totale-prel-campo"></td>
      <td class="totale-prod-ed"></td>
      <td class="totale-imm-ed"></td>
      <td class="totale-prel-ed"></td>
      <td class="totale-prod-gse"></td>
      <td class="totale-imm-gse"></td>
	  <td></td>
	  <td></td>

    </tr>
    <tr>
      
      <td colspan="3"><sup>*</sup><i class="fa fa-bolt" aria-hidden="true"></i>&nbsp;<i>Delta percentuale di produzione</i></td>
      <td></td>
      <td colspan="3"><sup>*</sup><i class="fa fa-share" aria-hidden="true" ></i>&nbsp;<i>Delta percentuale di immissione</i></td>
      <td></td>
      <td></td>
      <td></td>
	  <td></td>
     
    </tr>
  </tfoot>
</table>

<div class="text-center mt-3">
  <button id="refresh-table2-data-{{ anno }}" class="btn btn-secondary">Aggiorna Dati</button>
</div>

<!-- Alert per messaggi di caricamento -->
<div id="loading-alert-{{ anno }}" class="alert alert-info mt-3" style="display: none;" role="alert">
  Caricamento dati in corso...
</div>
<div id="success-table2-alert-{{ anno }}" class="alert alert-success mt-3" style="display: none;" role="alert">
  Dati caricati con successo!
</div>
<div id="error-table2-alert-{{ anno }}" class="alert alert-danger mt-3" style="display: none;" role="alert">
  Errore durante il caricamento dei dati.
</div>

<!-- Script JavaScript per il caricamento dinamico dei dati -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Carica i dati al caricamento della pagina
    caricaDatiTabella2('{{ anno }}', '{{ nickname }}');
    
    // Aggiungi event listener per il pulsante di aggiornamento
    document.getElementById('refresh-table2-data-{{ anno }}').addEventListener('click', function() {
      caricaDatiTabella2('{{ anno }}', '{{ nickname }}');
    });
  });

  // Funzione per caricare i dati della tabella 2
  function caricaDatiTabella2(anno, nickname) {
    // Mostra l'alert di caricamento
    document.getElementById('loading-alert-' + anno).style.display = 'block';
    
    // Nasconde gli alert precedenti
    document.getElementById('success-table2-alert-' + anno).style.display = 'none';
    document.getElementById('error-table2-alert-' + anno).style.display = 'none';
    
    // Effettua la richiesta AJAX per ottenere i dati
    fetch(`/corrispettivi/api/misure/${anno}_${nickname}/`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Errore nella risposta del server');
        }
        return response.json();
      })
      .then(data => {
        // Popola la tabella con i dati ricevuti
        popolaTabella2(data.TableMisure, anno);
        
        // Nascondi l'alert di caricamento e mostra quello di successo
        document.getElementById('loading-alert-' + anno).style.display = 'none';
        document.getElementById('success-table2-alert-' + anno).style.display = 'block';
        
        // Nascondi l'alert di successo dopo 3 secondi
        setTimeout(() => {
          document.getElementById('success-table2-alert-' + anno).style.display = 'none';
        }, 3000);
      })
      .catch(error => {
        console.error('Errore:', error);
        
        // Nascondi l'alert di caricamento e mostra quello di errore
        document.getElementById('loading-alert-' + anno).style.display = 'none';
        document.getElementById('error-table2-alert-' + anno).style.display = 'block';
      });
  }

  // Funzione per popolare la tabella con i dati
  function popolaTabella2(dati, anno) {
    const mesiNomi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                     'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    
    // Totali per i calcoli finali
    let totali = {
      prod_campo: 0, imm_campo: 0, prel_campo: 0,
      prod_ed: 0, imm_ed: 0, prel_ed: 0,
      prod_gse: 0, imm_gse: 0
    };
    
    // Popola le celle della tabella con i dati
    for (let i = 0; i < dati.length; i++) {
      const dato = dati[i];
      const mese = dato.mese;
      const meseIndex = mese - 1;
      
      // Imposta il nome del mese
      document.querySelector(`#table2_${anno} .mese[data-mese="${mese}"]`).textContent = mesiNomi[meseIndex];
      
      // Imposta i valori per ogni cella
      document.querySelector(`#table2_${anno} .prod-campo[data-mese="${mese}"]`).textContent = dato.prod_campo || '';
      document.querySelector(`#table2_${anno} .imm-campo[data-mese="${mese}"]`).textContent = dato.imm_campo || '';
      document.querySelector(`#table2_${anno} .prel-campo[data-mese="${mese}"]`).textContent = dato.prel_campo || '';
      document.querySelector(`#table2_${anno} .prod-ed[data-mese="${mese}"]`).textContent = dato.prod_ed || '';
      document.querySelector(`#table2_${anno} .imm-ed[data-mese="${mese}"]`).textContent = dato.imm_ed || '';
      document.querySelector(`#table2_${anno} .prel-ed[data-mese="${mese}"]`).textContent = dato.prel_ed || '';
      document.querySelector(`#table2_${anno} .prod-gse[data-mese="${mese}"]`).textContent = dato.prod_gse || '';
      document.querySelector(`#table2_${anno} .imm-gse[data-mese="${mese}"]`).textContent = dato.imm_gse || '';
      
      // Controllo misure con indicatori di differenza percentuale
      let controlloHTML = '';
      if (dato.prod_campo && dato.prod_ed) {
        const diffProd = ((parseFloat(dato.prod_campo) - parseFloat(dato.prod_ed)) / parseFloat(dato.prod_ed) * 100).toFixed(2);
        controlloHTML += `<i class="fa fa-bolt" aria-hidden="true"></i> ${diffProd}%<br>`;
      }
      
      if (dato.imm_campo && dato.imm_ed) {
        const diffImm = ((parseFloat(dato.imm_campo) - parseFloat(dato.imm_ed)) / parseFloat(dato.imm_ed) * 100).toFixed(2);
        controlloHTML += `<i class="fa fa-share" aria-hidden="true"></i> ${diffImm}%`;
      }
      
      document.querySelector(`#table2_${anno} .controllo[data-mese="${mese}"]`).innerHTML = controlloHTML;
      
      // Aggiorna i totali
      totali.prod_campo += parseFloat(dato.prod_campo || 0);
      totali.imm_campo += parseFloat(dato.imm_campo || 0);
      totali.prel_campo += parseFloat(dato.prel_campo || 0);
      totali.prod_ed += parseFloat(dato.prod_ed || 0);
      totali.imm_ed += parseFloat(dato.imm_ed || 0);
      totali.prel_ed += parseFloat(dato.prel_ed || 0);
      totali.prod_gse += parseFloat(dato.prod_gse || 0);
      totali.imm_gse += parseFloat(dato.imm_gse || 0);
    }
    
    // Aggiorna i totali nella tabella
    document.querySelector(`#table2_${anno} .totale-prod-campo`).textContent = totali.prod_campo.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-imm-campo`).textContent = totali.imm_campo.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-prel-campo`).textContent = totali.prel_campo.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-prod-ed`).textContent = totali.prod_ed.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-imm-ed`).textContent = totali.imm_ed.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-prel-ed`).textContent = totali.prel_ed.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-prod-gse`).textContent = totali.prod_gse.toFixed(3);
    document.querySelector(`#table2_${anno} .totale-imm-gse`).textContent = totali.imm_gse.toFixed(3);
  }
</script>